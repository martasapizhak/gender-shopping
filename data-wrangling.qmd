---
title: "Preliminary data wrangling"
author: "Marta Sapizhak"
format: pdf
---

```{r load_lib}
#| message: false
#| warning: false
#| include: false
#| echo: false

# Loading necessary packages
library(tidyverse)
library(kableExtra)   # for creating nicely formatted tables in Quarto
library(broom)        # for using augment
library(dplyr)
library(readr)
library(ggplot2)
library(car)
library(pROC)

```

```{r load_data}
#| message: false
#| warning: false
#| echo: true

raw_data <- read_csv("shopping_trends.csv")
head(raw_data) |>
  kable() |>
  kable_styling(bootstrap_options = c("striped"))
```

There are no missing values and the dataset is overall cleaned. Some of the things we need to account for to make sure we compare apples to apples are:

- gender - one of key explanatory
- items and categories - one of key explanatory - need to group better to lower the number of categ variables
- size - the key explanatory
- prices - response variable? how to measure the chances that the same thing for a man will be cheaper? Multiple regression?
- season - one of key explanatory
- age - may be one of the further analysis explanatory.

```{r relevant_vars}
#| message: false
#| warning: false
#| echo: true

nrow_before_clean <- (nrow(raw_data))

# Remove specified columns
cols_to_remove <- c("Frequency of Purchases", "Previous Purchases", 
                  "Preferred Payment Method", "Payment Method", 
                  "Review Rating", "Discount Applied", "Promo Code Used", 
                  "Subscription Status", "Shipping Type")

data <- raw_data |>
  filter(`Discount Applied` == 'No', `Promo Code Used` == "No") |>
  select(-all_of(cols_to_remove))

nrow_after_clean <- (nrow(data))

```

Our initial data has had `r nrow_before_clean` observations initially and after the filtering, it's `r nrow_after_clean`

The sales taxes correlation was basically not significant and small enough to disregard. Similarly since gender will be similarly distributed across values, we can disregard differences in shipping prices and other things, since the information about it is limited and we expect them to be fairly even between the two genders considered in the study.

```{r sales_taxes}
#| message: false
#| warning: false
#| echo: true

# Read tax data
tax_data <- read.csv("LOST_July_2024_Rate_Table.csv")

# Clean tax data - remove % and convert to numeric
tax_data$Combined_Rate <- as.numeric(sub("%", "", tax_data$Combined.Rate))

# Calculate median prices by state
state_prices <- data |>
  group_by(Location) |>
  summarise(
    median_price = median(`Purchase Amount (USD)`),
    n_transactions = n()
  )

# Merge with tax data
comparison <- merge(state_prices, tax_data, 
                  by.x="Location", by.y="State")

# Run linear regression
model <- lm(median_price ~ Combined_Rate, data=comparison)

print(tidy(model)) 
```
One thing we definitely want to account for is the different item types. To simplify the analysis we want to separate them into more categories than we are given, since those aren't thoroughly informative but at the same time we need less unique values for this categorical variable.

```{r group_items}
#| message: false
#| warning: false
#| echo: true

# First, let's see all unique items
unique_items <- sort(unique(data$`Item.Purchased`))

# Create a function to categorize items
categorize_items <- function(item) {
  tops <- c("T-shirt", "Blouse", "Shirt", "Tank Top", "Sweater", "Hoodie", "Sweatshirt", "Cardigan", "Polo")
  bottoms <- c("Pants", "Jeans", "Shorts", "Skirt", "Leggings", "Trousers")
  full_body <- c("Dress", "Suit", "Jumpsuit", "Romper")
  outerwear <- c("Jacket", "Coat", "Blazer", "Windbreaker")
  accessories <- c("Belt", "Scarf", "Hat", "Cap", "Gloves", "Tie", "Socks")
  footwear <- c("Shoes", "Boots", "Sandals", "Sneakers", "Heels")
  bags <- c("Backpack", "Handbag", "Purse", "Wallet", "Tote")
  
  # Categorize
  if(item %in% tops) return("Tops")
  if(item %in% bottoms) return("Bottoms")
  if(item %in% full_body) return("Full Body")
  if(item %in% outerwear) return("Outerwear")
  if(item %in% accessories) return("Accessories")
  if(item %in% footwear) return("Footwear")
  if(item %in% bags) return("Bags")
  return("Other")
}

# Apply categorization
data$Item_Category <- sapply(data$`Item Purchased`, categorize_items)

# Get summary of new categories
category_summary <- table(data$Item_Category)
category_df <- data.frame(
  Category = names(category_summary),
  Count = as.numeric(category_summary),
  Percentage = round(as.numeric(prop.table(category_summary)) * 100, 2)
)

ggplot(category_df, aes(x = Count, y = Category, fill = Category)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  theme_minimal() +
  labs(title = "Distribution of Item Categories",
       x = "Category",
       y = "Count")
```

Does season is what I think it is - the season of the item style or is it when it was purchased?
One thing that came up - idk why sometimes i need to call it as Price.Paid vs `Price Paid`

```{r season}
#| message: false
#| warning: false
#| echo: true

head(data |> 
  filter(Category == "Outerwear")) |> 
  kable() |>
  kable_styling(bootstrap_options = c("striped"))


# Analyze by Season
season_item_analysis <- data |>
 group_by(Season, `Item Purchased`) |>
 summarise(
   count = n(),
   .groups = 'drop'
 ) |>
 arrange(Season, desc(count))

# Get top items for each season
top_items_by_season <- season_item_analysis |>
 group_by(Season) |>
 slice_max(order_by = count, n = 3)

top_items_by_season |>
  kable() |>
  kable_styling(bootstrap_options = c("striped", "hover"))


```

Seems like the season might be impacting data not in the way that we'd expect. For now, just still treat season as an explanatory variable.


Now that we have all settled - look at the data again:

```{r draft}
#| message: false
#| warning: false
#| echo: true

data
```

```{r}
#| message: false
#| warning: false
#| echo: true

table(data$Size)
```

Our primary question is whether the gender is very important for when buying XL, L clothes. To account for confounding variables - 
the model explanatory are: item types, season, location, age, color(pink tax?) specifically for pink??

- prices - response variable? how to measure the chances that the same thing for a man will be cheaper? Multiple regression?
- season - one of key explanatory
- age - may be one of the further analysis explanatory.

At this stage there are two questions we can pose - /

Multiple linear regression modeling:/
Do women pay more for larger size of clothing? - think about what categories and items it involves

What variable is most significant in determining the gender of the buyer?


